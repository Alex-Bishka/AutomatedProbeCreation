{% extends "base.html" %}

{% block title %}Automated Pipeline - SAE Steering{% endblock %}

{% block content %}
<h2>Automated Deception Probe Pipeline</h2>

<p>Run the autonomous pipeline to generate scenarios, select features, apply steering, and evaluate results.</p>

<div class="pipeline-container">
    <!-- Configuration Section -->
    <div class="section">
        <h3>Pipeline Configuration</h3>

        <div class="form-group">
            <label for="num-scenarios">Number of Scenarios to Generate</label>
            <input type="number" id="num-scenarios" value="5" min="1" max="20">
        </div>

        <div class="form-group">
            <label for="target-model">Target Model</label>
            <select id="target-model">
                <option value="llama3.1-8b-it" selected>Llama 3.1 8B Instruct</option>
                <option value="llama3.3-70b-it">Llama 3.3 70B Instruct</option>
                <option value="gemma-2-9b-it">Gemma 2 9B Instruct</option>
            </select>
        </div>

        <div class="form-group">
            <label for="max-features">Max Features per Concept</label>
            <input type="number" id="max-features" value="3" min="1" max="10">
        </div>

        <div class="form-group">
            <label style="display: flex; align-items: center; gap: 0.5rem;">
                <input type="checkbox" id="high-quality-mode">
                High Quality Mode (uses Gemini 2.5 Pro instead of Flash)
            </label>
        </div>

        <button id="start-pipeline-btn" class="btn primary" onclick="startPipeline()">
            Start Pipeline
        </button>
    </div>

    <!-- Progress Section (hidden by default) -->
    <div id="progress-section" class="section" style="display: none;">
        <h3>Pipeline Progress</h3>
        <div class="progress-container">
            <div id="progress-bar" class="progress-bar"></div>
        </div>
        <div id="progress-status" class="progress-status">Initializing...</div>
        <div id="progress-log" class="progress-log"></div>
    </div>

    <!-- Results Section (hidden by default) -->
    <div id="results-section" class="section" style="display: none;">
        <h3>Pipeline Results</h3>
        <div id="results-content"></div>
    </div>
</div>

<!-- Recent Jobs Section -->
<div class="section mt-2">
    <h3>Recent Pipeline Jobs</h3>

    {% if jobs %}
    <table>
        <thead>
            <tr>
                <th>Job ID</th>
                <th>Started</th>
                <th>Status</th>
                <th>Config</th>
                <th>Results</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for job in jobs %}
            <tr>
                <td><code>{{ job.id[:20] }}...</code></td>
                <td>{{ job.created_at[:19] }}</td>
                <td>
                    <span class="status-badge status-{{ job.status }}">{{ job.status }}</span>
                </td>
                <td>
                    {% if job.config %}
                    {{ job.config.num_scenarios }} scenarios,
                    {{ job.config.target_model }}
                    {% if job.config.high_quality_mode %}(HQ){% endif %}
                    {% endif %}
                </td>
                <td>
                    {% if job.results %}
                    {{ job.results.successes }}/{{ job.results.scenarios_approved }} success,
                    {{ job.results.review_items }} pending review
                    {% elif job.error %}
                    <span class="text-danger">Error: {{ job.error[:50] }}...</span>
                    {% else %}
                    -
                    {% endif %}
                </td>
                <td>
                    <a href="/pipeline/job/{{ job.id }}" class="btn btn-sm">View</a>
                    <button class="btn btn-sm btn-danger" onclick="deleteJob('{{ job.id }}')">Delete</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="text-muted">No pipeline jobs yet. Start a pipeline run above.</p>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
let pipelineRunning = false;

async function startPipeline() {
    if (pipelineRunning) {
        alert('Pipeline is already running');
        return;
    }

    const numScenarios = parseInt(document.getElementById('num-scenarios').value);
    const targetModel = document.getElementById('target-model').value;
    const maxFeatures = parseInt(document.getElementById('max-features').value);
    const highQualityMode = document.getElementById('high-quality-mode').checked;

    // Show progress section
    document.getElementById('progress-section').style.display = 'block';
    document.getElementById('results-section').style.display = 'none';
    document.getElementById('start-pipeline-btn').disabled = true;
    pipelineRunning = true;

    // Reset progress
    document.getElementById('progress-bar').style.width = '0%';
    document.getElementById('progress-status').textContent = 'Starting pipeline...';
    document.getElementById('progress-log').innerHTML = '';

    addLog('Starting pipeline with configuration:');
    addLog(`  - Scenarios: ${numScenarios}`);
    addLog(`  - Target Model: ${targetModel}`);
    addLog(`  - Max Features/Concept: ${maxFeatures}`);
    addLog(`  - High Quality Mode: ${highQualityMode}`);

    try {
        addLog('Sending request to server...');
        updateProgress(10, 'Initializing agents...');

        const response = await fetch('/api/pipeline/start', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                num_scenarios: numScenarios,
                target_model: targetModel,
                max_features_per_concept: maxFeatures,
                high_quality_mode: highQualityMode
            })
        });

        const data = await response.json();

        if (data.error) {
            throw new Error(data.error);
        }

        // Show results
        updateProgress(100, 'Pipeline completed!');
        showResults(data);

    } catch (error) {
        addLog(`ERROR: ${error.message}`, 'error');
        updateProgress(0, 'Pipeline failed');
        document.getElementById('progress-status').classList.add('error');
    } finally {
        pipelineRunning = false;
        document.getElementById('start-pipeline-btn').disabled = false;
    }
}

function updateProgress(percent, status) {
    document.getElementById('progress-bar').style.width = `${percent}%`;
    document.getElementById('progress-status').textContent = status;
}

function addLog(message, type = 'info') {
    const log = document.getElementById('progress-log');
    const timestamp = new Date().toLocaleTimeString();
    const className = type === 'error' ? 'log-error' : (type === 'success' ? 'log-success' : '');
    log.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
    log.scrollTop = log.scrollHeight;
}

async function deleteJob(jobId) {
    if (!confirm('Are you sure you want to delete this job?')) {
        return;
    }

    try {
        const response = await fetch(`/api/pipeline/jobs/${jobId}`, {
            method: 'DELETE'
        });
        const data = await response.json();

        if (data.success) {
            window.location.reload();
        } else {
            alert('Error deleting job: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Error deleting job: ' + error.message);
    }
}

function showResults(data) {
    document.getElementById('results-section').style.display = 'block';

    const results = data.results;
    const html = `
        <div class="results-grid">
            <div class="result-card">
                <div class="result-value">${results.templates_used}</div>
                <div class="result-label">Templates Used</div>
            </div>
            <div class="result-card">
                <div class="result-value">${results.scenarios_generated}</div>
                <div class="result-label">Scenarios Generated</div>
            </div>
            <div class="result-card">
                <div class="result-value">${results.scenarios_approved}</div>
                <div class="result-label">Scenarios Approved</div>
            </div>
            <div class="result-card">
                <div class="result-value">${results.features_count}</div>
                <div class="result-label">Features Selected</div>
            </div>
            <div class="result-card success">
                <div class="result-value">${results.successes}</div>
                <div class="result-label">Successes</div>
            </div>
            <div class="result-card failure">
                <div class="result-value">${results.failures}</div>
                <div class="result-label">Failures</div>
            </div>
            <div class="result-card pending">
                <div class="result-value">${results.review_items}</div>
                <div class="result-label">Pending Review</div>
            </div>
        </div>
        <div class="mt-1">
            <h4>Extracted Concepts</h4>
            <div class="concepts-list">
                ${results.concepts.map(c => `<span class="concept-tag">${c}</span>`).join('')}
            </div>
        </div>
        <div class="mt-1">
            <p>Job ID: <code>${data.job_id}</code></p>
            ${results.review_items > 0 ?
                `<a href="/review" class="btn primary">Review Pending Items (${results.review_items})</a>` :
                ''
            }
        </div>
    `;

    document.getElementById('results-content').innerHTML = html;
    addLog(`Pipeline completed: ${results.successes} successes, ${results.failures} failures, ${results.review_items} pending review`, 'success');
}
</script>

<style>
.pipeline-container {
    max-width: 800px;
}

.form-group {
    margin-bottom: 1rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
}

.form-group input[type="number"],
.form-group select {
    padding: 0.5rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 1rem;
}

.form-group input[type="checkbox"] {
    margin-right: 0.5rem;
}

.progress-container {
    background: #e0e0e0;
    border-radius: 4px;
    height: 20px;
    overflow: hidden;
    margin-bottom: 0.5rem;
}

.progress-bar {
    background: linear-gradient(90deg, #3b82f6, #10b981);
    height: 100%;
    transition: width 0.3s ease;
}

.progress-status {
    font-weight: 500;
    margin-bottom: 0.5rem;
}

.progress-status.error {
    color: #ef4444;
}

.progress-log {
    background: #1a1a2e;
    color: #e0e0e0;
    font-family: monospace;
    font-size: 0.85rem;
    padding: 1rem;
    border-radius: 4px;
    max-height: 200px;
    overflow-y: auto;
}

.progress-log .log-error {
    color: #ef4444;
}

.progress-log .log-success {
    color: #10b981;
}

.results-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 1rem;
}

.result-card {
    background: #f5f5f5;
    padding: 1rem;
    border-radius: 8px;
    text-align: center;
}

.result-card.success {
    background: #d1fae5;
    border: 1px solid #10b981;
}

.result-card.failure {
    background: #fee2e2;
    border: 1px solid #ef4444;
}

.result-card.pending {
    background: #fef3c7;
    border: 1px solid #f59e0b;
}

.result-value {
    font-size: 2rem;
    font-weight: bold;
    color: #1a1a2e;
}

.result-label {
    font-size: 0.85rem;
    color: #666;
    margin-top: 0.25rem;
}

.concepts-list {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.concept-tag {
    background: #e0e7ff;
    color: #3730a3;
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.85rem;
}

.status-badge {
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
}

.status-running {
    background: #fef3c7;
    color: #92400e;
}

.status-completed {
    background: #d1fae5;
    color: #065f46;
}

.status-failed {
    background: #fee2e2;
    color: #991b1b;
}

.status-cancelled {
    background: #e5e7eb;
    color: #4b5563;
}

.text-danger {
    color: #ef4444;
}

.mt-1 {
    margin-top: 1rem;
}

.mt-2 {
    margin-top: 2rem;
}

.btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.8rem;
}

.btn-danger {
    background: #ef4444;
    color: white;
    border: none;
}

.btn-danger:hover {
    background: #dc2626;
}
</style>
{% endblock %}
