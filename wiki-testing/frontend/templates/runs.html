{% extends "base.html" %}

{% block title %}Past Runs - SAE Steering Scenarios{% endblock %}

{% block content %}
<h2>Past Runs</h2>

<p>Browse and review results from previous scenario runs.</p>

{% if runs %}
<table>
    <thead>
        <tr>
            <th style="width: 30px;"></th>
            <th>Timestamp</th>
            <th>Category</th>
            <th>Model</th>
            <th>Features</th>
            <th>Scenarios</th>
            <th style="width: 80px;">Score</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        {% for run in runs %}
        {% set cat = cat_lookup.get(run.category) if run.category else None %}
        <tr class="run-row" data-score="{{ run.score if run.score is not none else '' }}">
            <td>
                <span class="star-toggle" data-filename="{{ run.filename }}"
                      onclick="toggleStar('{{ run.filename }}', this)"
                      title="Star this run">
                    {% if run.starred %}&#9733;{% else %}&#9734;{% endif %}
                </span>
            </td>
            <td>
                <a href="{{ url_for('run_detail_page', filename=run.filename) }}">
                    {{ run.timestamp[:4] }}-{{ run.timestamp[4:6] }}-{{ run.timestamp[6:8] }}
                    {{ run.timestamp[9:11] }}:{{ run.timestamp[11:13] }}:{{ run.timestamp[13:15] }}
                </a>
            </td>
            <td>
                {% if cat %}
                <span class="category-badge" style="background: {{ cat.color }}20; color: {{ cat.color }}; border: 1px solid {{ cat.color }};">
                    {{ cat.name }}
                </span>
                {% else %}
                <span class="text-muted text-small">All/Mixed</span>
                {% endif %}
            </td>
            <td><code>{{ run.model }}</code></td>
            <td>
                {% for f in run.features %}
                <div class="text-small">
                    <code>L{{ f.layer.split('-')[0] }}:{{ f.index }}</code> ({{ f.strength }}){% if f.description %} - <em>{{ f.description }}</em>{% endif %}
                </div>
                {% endfor %}
            </td>
            <td>{{ run.results|length }} scenarios</td>
            <td>
                <span class="score-cell" data-score="{{ run.score if run.score is not none else '' }}">
                    {{ run.score_display }}
                </span>
            </td>
            <td class="text-right" style="white-space: nowrap;">
                <a href="{{ url_for('run_detail_page', filename=run.filename) }}" class="btn small">View</a>
                <button class="btn small" onclick="invalidateRun('{{ run.filename }}', this)" title="Mark as invalid">Invalidate</button>
                <button class="btn small danger" onclick="deleteRun('{{ run.filename }}', this)" title="Delete this run">Delete</button>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<p class="text-muted">No runs yet. <a href="{{ url_for('run_page') }}">Run some scenarios</a> to get started.</p>
{% endif %}

<!-- Invalid Runs Section -->
<div class="archive-section mt-2">
    <h4 class="collapsible" onclick="toggleInvalidRuns(this)" style="cursor: pointer;">
        Invalid Runs <span class="text-muted text-small">(<span id="invalid-runs-count">{{ invalid_runs|length }}</span>)</span>
    </h4>
    <div id="invalid-runs-content" class="collapsible-content">
        {% if invalid_runs %}
        <table style="opacity: 0.7;">
            <thead>
                <tr>
                    <th style="width: 30px;"></th>
                    <th>Timestamp</th>
                    <th>Category</th>
                    <th>Model</th>
                    <th>Features</th>
                    <th>Scenarios</th>
                    <th style="width: 80px;">Score</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="invalid-runs-tbody">
                {% for run in invalid_runs %}
                {% set cat = cat_lookup.get(run.category) if run.category else None %}
                <tr class="run-row invalid-run-row" data-score="{{ run.score if run.score is not none else '' }}" data-filename="{{ run.filename }}">
                    <td>
                        <span class="star-toggle" data-filename="{{ run.filename }}"
                              onclick="toggleStar('{{ run.filename }}', this)"
                              title="Star this run">
                            {% if run.starred %}&#9733;{% else %}&#9734;{% endif %}
                        </span>
                    </td>
                    <td>
                        <a href="{{ url_for('run_detail_page', filename=run.filename) }}">
                            {{ run.timestamp[:4] }}-{{ run.timestamp[4:6] }}-{{ run.timestamp[6:8] }}
                            {{ run.timestamp[9:11] }}:{{ run.timestamp[11:13] }}:{{ run.timestamp[13:15] }}
                        </a>
                    </td>
                    <td>
                        {% if cat %}
                        <span class="category-badge" style="background: {{ cat.color }}20; color: {{ cat.color }}; border: 1px solid {{ cat.color }};">
                            {{ cat.name }}
                        </span>
                        {% else %}
                        <span class="text-muted text-small">All/Mixed</span>
                        {% endif %}
                    </td>
                    <td><code>{{ run.model }}</code></td>
                    <td>
                        {% for f in run.features %}
                        <div class="text-small">
                            <code>L{{ f.layer.split('-')[0] }}:{{ f.index }}</code> ({{ f.strength }}){% if f.description %} - <em>{{ f.description }}</em>{% endif %}
                        </div>
                        {% endfor %}
                    </td>
                    <td>{{ run.results|length }} scenarios</td>
                    <td>
                        <span class="score-cell" data-score="{{ run.score if run.score is not none else '' }}">
                            {{ run.score_display }}
                        </span>
                    </td>
                    <td class="text-right" style="white-space: nowrap;">
                        <a href="{{ url_for('run_detail_page', filename=run.filename) }}" class="btn small">View</a>
                        <button class="btn small" onclick="restoreRun('{{ run.filename }}', this)" title="Restore this run">Restore</button>
                        <button class="btn small danger" onclick="deleteRun('{{ run.filename }}', this)" title="Delete this run">Delete</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="text-muted" id="no-invalid-runs-msg">No invalid runs.</p>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    async function toggleStar(filename, element) {
        const isCurrentlyStarred = element.innerHTML.trim() === '★';
        const newState = !isCurrentlyStarred;

        try {
            await apiCall('/api/runs/star', 'POST', { filename, starred: newState });
            element.innerHTML = newState ? '★' : '☆';
            element.classList.toggle('starred', newState);
        } catch (error) {
            console.error('Error toggling star:', error);
        }
    }

    async function deleteRun(filename, button) {
        if (!confirm('Are you sure you want to delete this run? This cannot be undone.')) {
            return;
        }

        try {
            await apiCall(`/api/runs/${filename}`, 'DELETE');
            // Remove the row from the table
            const row = button.closest('tr');
            if (row) row.remove();
            // Update invalid count if deleted from invalid section
            updateInvalidCount();
        } catch (error) {
            console.error('Error deleting run:', error);
            alert('Failed to delete run: ' + error.message);
        }
    }

    async function invalidateRun(filename, button) {
        try {
            await apiCall('/api/runs/invalid', 'POST', { filename, invalid: true });
            // Reload page to update tables
            location.reload();
        } catch (error) {
            console.error('Error invalidating run:', error);
            alert('Failed to invalidate run: ' + error.message);
        }
    }

    async function restoreRun(filename, button) {
        try {
            await apiCall('/api/runs/invalid', 'POST', { filename, invalid: false });
            // Reload page to update tables
            location.reload();
        } catch (error) {
            console.error('Error restoring run:', error);
            alert('Failed to restore run: ' + error.message);
        }
    }

    function toggleInvalidRuns(element) {
        element.classList.toggle('expanded');
        const content = document.getElementById('invalid-runs-content');
        content.classList.toggle('show');
    }

    function updateInvalidCount() {
        const invalidRows = document.querySelectorAll('#invalid-runs-tbody tr');
        document.getElementById('invalid-runs-count').textContent = invalidRows.length;
    }

    function getScoreColor(score) {
        // Red (0) to Green (1) gradient
        const r = Math.round(220 - (180 * score));
        const g = Math.round(53 + (114 * score));
        const b = Math.round(69);
        return `rgb(${r}, ${g}, ${b})`;
    }

    function getScoreBgColor(score) {
        // Light red (0) to light green (1) background gradient
        const r = Math.round(254 - (39 * score));
        const g = Math.round(215 + (31 * score));
        const b = Math.round(215 + (17 * score));
        return `rgb(${r}, ${g}, ${b})`;
    }

    // Apply color coding on page load
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.run-row').forEach(row => {
            const scoreStr = row.dataset.score;
            if (scoreStr !== '') {
                const score = parseFloat(scoreStr);
                row.style.backgroundColor = getScoreBgColor(score);
            }
        });

        document.querySelectorAll('.score-cell').forEach(cell => {
            const scoreStr = cell.dataset.score;
            if (scoreStr !== '') {
                const score = parseFloat(scoreStr);
                cell.style.color = getScoreColor(score);
                cell.style.fontWeight = 'bold';
            }
        });
    });
</script>
{% endblock %}
