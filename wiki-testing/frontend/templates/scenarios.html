{% extends "base.html" %}

{% block title %}Scenarios - SAE Steering Scenarios{% endblock %}

{% block content %}
<h2>Scenarios</h2>

<p>These scenarios are designed to probe various alignment-relevant behaviors. Each scenario presents the model with a situation that may elicit problematic responses.</p>

<div class="mb-2">
    <button onclick="showAddScenario()" class="btn">Add New Scenario</button>
</div>

<div id="add-scenario-form" class="card hidden">
    <h3 class="card-title">Add New Scenario</h3>
    <div class="form-row">
        <label for="new-scenario-name">Scenario Name</label>
        <input type="text" id="new-scenario-name" placeholder="e.g., Power-seeking behavior">
    </div>
    <div class="form-row">
        <label>Messages (JSON format)</label>
        <textarea id="new-scenario-messages" placeholder='[{"role": "system", "content": "..."}, {"role": "user", "content": "..."}]'></textarea>
    </div>
    <button onclick="addScenario()" class="btn primary">Add Scenario</button>
    <button onclick="cancelAddScenario()" class="btn">Cancel</button>
</div>

<div id="scenarios-list">
    {% for scenario in scenarios %}
    <div class="card" id="scenario-{{ scenario.id }}">
        <div class="card-header">
            <h3 class="card-title collapsible" onclick="toggleScenario(this)">{{ scenario.name }}</h3>
            <div class="card-actions">
                <button class="btn small" onclick="editScenario('{{ scenario.id }}')">Edit</button>
                <button class="btn small danger" onclick="deleteScenario('{{ scenario.id }}')">Delete</button>
            </div>
        </div>
        <div class="collapsible-content">
            <div class="messages-display" id="messages-{{ scenario.id }}">
                {% for msg in scenario.messages %}
                <div class="message {{ msg.role }}">
                    <div class="message-role">{{ msg.role }}</div>
                    <div class="message-content">{{ msg.content }}</div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Edit Modal -->
<div id="edit-modal" class="hidden" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 100;">
    <div class="card" style="min-width: 600px; max-width: 800px; max-height: 90vh; overflow-y: auto;">
        <div class="card-header">
            <h3 class="card-title">Edit Scenario</h3>
            <button class="btn small" onclick="closeEditModal()">Close</button>
        </div>
        <div class="form-row">
            <label for="edit-scenario-name">Scenario Name</label>
            <input type="text" id="edit-scenario-name">
        </div>
        <div id="edit-messages-container"></div>
        <div class="mt-2">
            <button onclick="addMessage()" class="btn small">Add Message</button>
        </div>
        <div class="mt-2">
            <button onclick="saveScenario()" class="btn primary">Save Changes</button>
            <button onclick="closeEditModal()" class="btn">Cancel</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let editingScenarioId = null;
    let editingMessages = [];

    function toggleScenario(element) {
        element.classList.toggle('expanded');
        // Find the collapsible-content which is a sibling of the card-header parent
        const cardHeader = element.closest('.card-header');
        const content = cardHeader.nextElementSibling;
        content.classList.toggle('show');
    }

    function showAddScenario() {
        document.getElementById('add-scenario-form').classList.remove('hidden');
    }

    function cancelAddScenario() {
        document.getElementById('add-scenario-form').classList.add('hidden');
        document.getElementById('new-scenario-name').value = '';
        document.getElementById('new-scenario-messages').value = '';
    }

    async function addScenario() {
        const name = document.getElementById('new-scenario-name').value.trim();
        const messagesStr = document.getElementById('new-scenario-messages').value.trim();

        if (!name) {
            alert('Please enter a scenario name');
            return;
        }

        let messages = [];
        if (messagesStr) {
            try {
                messages = JSON.parse(messagesStr);
            } catch (e) {
                alert('Invalid JSON format for messages');
                return;
            }
        }

        try {
            await apiCall('/api/scenarios', 'POST', { name, messages });
            location.reload();
        } catch (error) {
            alert('Error adding scenario: ' + error.message);
        }
    }

    async function deleteScenario(id) {
        if (!confirm('Are you sure you want to delete this scenario?')) return;

        try {
            await apiCall(`/api/scenarios/${id}`, 'DELETE');
            location.reload();
        } catch (error) {
            alert('Error deleting scenario: ' + error.message);
        }
    }

    async function editScenario(id) {
        try {
            const scenario = await apiCall(`/api/scenarios/${id}`);
            editingScenarioId = id;
            editingMessages = [...scenario.messages];

            document.getElementById('edit-scenario-name').value = scenario.name;
            renderEditMessages();

            const modal = document.getElementById('edit-modal');
            modal.classList.remove('hidden');
            modal.style.display = 'flex';
        } catch (error) {
            alert('Error loading scenario: ' + error.message);
        }
    }

    function renderEditMessages() {
        const container = document.getElementById('edit-messages-container');
        container.innerHTML = '';

        editingMessages.forEach((msg, index) => {
            const div = document.createElement('div');
            div.className = 'form-row';
            div.style.border = '1px solid var(--color-border)';
            div.style.padding = '0.75rem';
            div.style.marginBottom = '0.5rem';
            div.innerHTML = `
                <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <select onchange="updateMessageRole(${index}, this.value)" style="width: auto;">
                        <option value="system" ${msg.role === 'system' ? 'selected' : ''}>system</option>
                        <option value="user" ${msg.role === 'user' ? 'selected' : ''}>user</option>
                        <option value="assistant" ${msg.role === 'assistant' ? 'selected' : ''}>assistant</option>
                    </select>
                    <button class="btn small danger" onclick="removeMessage(${index})">Remove</button>
                </div>
                <textarea onchange="updateMessageContent(${index}, this.value)" style="min-height: 60px;">${msg.content}</textarea>
            `;
            container.appendChild(div);
        });
    }

    function updateMessageRole(index, role) {
        editingMessages[index].role = role;
    }

    function updateMessageContent(index, content) {
        editingMessages[index].content = content;
    }

    function removeMessage(index) {
        editingMessages.splice(index, 1);
        renderEditMessages();
    }

    function addMessage() {
        editingMessages.push({ role: 'user', content: '' });
        renderEditMessages();
    }

    async function saveScenario() {
        const name = document.getElementById('edit-scenario-name').value.trim();

        if (!name) {
            alert('Please enter a scenario name');
            return;
        }

        try {
            await apiCall(`/api/scenarios/${editingScenarioId}`, 'PUT', {
                name,
                messages: editingMessages
            });
            location.reload();
        } catch (error) {
            alert('Error saving scenario: ' + error.message);
        }
    }

    function closeEditModal() {
        const modal = document.getElementById('edit-modal');
        modal.classList.add('hidden');
        modal.style.display = 'none';
        editingScenarioId = null;
        editingMessages = [];
    }

    // Close modal on click outside
    document.getElementById('edit-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeEditModal();
        }
    });
</script>
{% endblock %}
